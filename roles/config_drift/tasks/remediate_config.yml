---

Not run

- name: Remediate configuration drift
  block:
    - name: Generate remediation commands from baseline
      set_fact:
        remediation_lines: "{{ baseline_lines_diff }}"

    - name: Filter out comments and empty lines from remediation
      set_fact:
        remediation_commands: "{{ remediation_lines | select('match', '^[^!#\\s].*') | list }}"

    - name: Display remediation commands to be applied
      debug:
        msg: |
          Remediation commands for {{ inventory_hostname }}:
          {{ remediation_commands | join('\n') }}

    - name: Apply configuration changes (dry run first)
      cli_config:
        config: "{{ remediation_commands | join('\n') }}"
        diff_against: running
      check_mode: yes
      register: dry_run_result

    - name: Confirm dry run results
      debug:
        msg: "Dry run completed successfully. Changes would be: {{ dry_run_result.diff | default('No changes detected') }}"

    - name: Apply configuration changes
      cli_config:
        config: "{{ remediation_commands | join('\n') }}"
        diff_against: running
      register: config_result
      when: 
        - dry_run_result is succeeded
        - remediation_commands | length > 0

    - name: Save configuration
      cli_command:
        command: "{{ save_config_command[ansible_network_os] }}"
      when: config_result is succeeded

    - name: Update drift results with remediation status
      set_fact:
        drift_results: "{{ drift_results | map('combine', {'remediated': true} if item.hostname == inventory_hostname else item) | list }}"
      when: config_result is succeeded

    - name: Add to remediated devices list
      set_fact:
        remediated_devices: "{{ remediated_devices + [inventory_hostname] }}"
      delegate_to: localhost
      when: config_result is succeeded

  rescue:
    - name: Record remediation failure
      set_fact:
        failed_devices: "{{ failed_devices + [failure_record] }}"
      vars:
        failure_record:
          hostname: "{{ inventory_hostname }}"
          error: "Remediation failed: {{ ansible_failed_result.msg | default('Unknown error') }}"
      delegate_to: localhost

    - name: Log remediation failure
      debug:
        msg: "Failed to remediate {{ inventory_hostname }}: {{ ansible_failed_result.msg | default('Unknown error') }}"